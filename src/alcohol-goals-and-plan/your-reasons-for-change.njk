{% extends "template.njk" %}

{% import "_pattern_macros/navigation_card.njk" as navcard %}
{% import "_pattern_macros/general_card.njk" as generalcard %}

{% set title = "Your reasons for change" %}

{% block main %}

  <section class="breadcrumbs">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb my-2">
          <li class="breadcrumb-item"><a href="{{ '/' | url }}">Home</a></li>
          <li class="breadcrumb-item"><a href="{{ '/' | url }}">Care, support and health</a></li>
          <li class="breadcrumb-item"><a href="{{ '/' | url }}">Health and wellbeing</a></li>
          <li class="breadcrumb-item"><a href="{{ '/' | url }}">Healthy lifestyles</a></li>
          <li class="breadcrumb-item"><a href="{{ '/help-to-cut-back-on-your-drinking/' | url }}">Help to cut back on your drinking</a></li>
          <li class="breadcrumb-item active">Alcohol goals and plan</li>
        </ol>
      </nav>
    </div>
  </section>

  <section class="section_stage_theme">
    <div class="container">
      <h1 class="h2">Alcohol goals and plan</h1>
    </div>
  </section>

  <section>
    <div class="container">
      <div class="col-12 col-md-9">
        <h2 class="h3 mb-2">Your reasons for change</h2>
        <p>Think about the most important reason or reasons why you want to cut down your drinking. It can be helpful to note down this reason and to remind yourself of it.</p>
        
        <h3 class="h4 mb-3 mt-4" style="font-weight: 700">The most important reason/s for wanting to lower my drinking is/are:</h3>

        <div class="row py-2" id="reasons-area-row">
          <div class="col-12 col-md-5" id="addReasonsDiv">
            
          </div>
        </div>

        <button id="addEditReasonsBtn" type="button" class="btn btn-primary btn-lg mb-4" data-bs-toggle="modal" data-bs-target="#reasonsModal"><svg width="28" height="28" viewBox="0 0 32 30" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M13 23C7.4875 23 3 18.5125 3 13C3 7.4875 7.4875 3 13 3C18.5125 3 23 7.4875 23 13C23 18.5125 18.5125 23 13 23ZM13 0.5C11.3585 0.5 9.73303 0.823322 8.21646 1.45151C6.69989 2.07969 5.3219 3.00043 4.16117 4.16117C1.81696 6.50537 0.5 9.68479 0.5 13C0.5 16.3152 1.81696 19.4946 4.16117 21.8388C5.3219 22.9996 6.69989 23.9203 8.21646 24.5485C9.73303 25.1767 11.3585 25.5 13 25.5C16.3152 25.5 19.4946 24.183 21.8388 21.8388C24.183 19.4946 25.5 16.3152 25.5 13C25.5 11.3585 25.1767 9.73303 24.5485 8.21646C23.9203 6.69989 22.9996 5.3219 21.8388 4.16117C20.6781 3.00043 19.3001 2.07969 17.7835 1.45151C16.267 0.823322 14.6415 0.5 13 0.5ZM14.25 6.75H11.75V11.75H6.75V14.25H11.75V19.25H14.25V14.25H19.25V11.75H14.25V6.75Z" fill="white"/>
</svg>
Add reason/s</button>

        <!-- Modal -->
        <div class="modal fade" id="reasonsModal" tabindex="-1" aria-labelledby="reasonsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title" id="reasonsModalLabel">Reasons</h4>
                <button type="button" class="modal-close-button btn-close text-reset" data-bs-dismiss="modal" aria-label="Close reasons window"></button>
              </div>
              <form id="reasonsForm">
                <div class="modal-body pt-0">
                  <div class="modal-selection-list">
                    <div id="reasonsList">
                    <div id="own-reason-area" class="mb-3">                 
                      <p class="reason-custom-label my-0">Add your own reason:</p>
                      <textarea class="selection-textarea mb-0" id="ownReason" name="reason-custom" rows="4" cols="50"></textarea>
                      <div>
                        <button class="btn btn-primary btn-lg" onclick="addCustomOption(document.getElementById('ownReason').value);" type="button">Add reason</button>
                      </div>
                    </div>
                    <div class="form-check reasons-checkbox">
                      <input class="form-check-input reasons-input" name="reasonsOption" type="checkbox" value="To be healthier" id="reason1">
                      <label class="form-check-label" for="reason1">
                        To be healthier
                      </label>
                    </div>
                    <div class="form-check reasons-checkbox">
                      <input class="form-check-input reasons-input" name="reasonsOption" type="checkbox" value="Save money" id="reason2">
                      <label class="form-check-label" for="reason2">
                        Save money 
                      </label>
                    </div>
                    <div class="form-check reasons-checkbox">
                      <input class="form-check-input reasons-input" name="reasonsOption" type="checkbox" value="No more hangovers" id="reason3">
                      <label class="form-check-label" for="reason3">
                        No more hangovers
                      </label>
                    </div>
                    <div class="form-check reasons-checkbox">
                      <input class="form-check-input reasons-input" name="reasonsOption" type="checkbox" value="Gain self-confidence" id="reason4">
                      <label class="form-check-label" for="reason4">
                        Gain self-confidence
                      </label>
                    </div>
                    <div class="form-check reasons-checkbox">
                      <input class="form-check-input reasons-input" name="reasonsOption" type="checkbox" value="Gain optimism" id="reason5">
                      <label class="form-check-label" for="reason5">
                        Gain optimism
                      </label>
                    </div>
                    <div class="form-check reasons-checkbox">
                      <input class="form-check-input reasons-input" name="reasonsOption" type="checkbox" value="You feel better" id="reason6">
                      <label class="form-check-label" for="reason6">
                        You feel better
                      </label>
                    </div>
                    <div class="form-check reasons-checkbox">
                      <input class="form-check-input reasons-input" name="reasonsOption" type="checkbox" value="Your brain heals" id="reason7">
                      <label class="form-check-label" for="reason7">
                        Your brain heals
                      </label>
                    </div>
                    <div class="form-check reasons-checkbox">
                      <input class="form-check-input reasons-input" name="reasonsOption" type="checkbox" value="No more guilt over your drinking" id="reason8">
                      <label class="form-check-label" for="reason8">
                        No more guilt over your drinking
                      </label>
                    </div>
                    </div>
                    
                    <hr>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn form-btn" data-bs-dismiss="modal" onclick="submitFormConfirm(this.form.reasonsOption);">Confirm reasons</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="double-btn-group">
          <input type="button" class="btn btn-lg form-btn form-btn-muted my-3 me-2" value="Previous" id="submit" onclick="submitFormBack();"></input>
          <input type="button" class="btn btn-lg form-btn my-3 ms-2" value="Continue" id="submit" onclick="submitFormContinue(reasonsForm.reasonsOption);"></input>
        </div>
      </div>
    </div>

    <script>
      
      let numberOfReasons = 0;

      window.onload = function() {
        let parentElementModal = document.getElementById("reasonsList");
        let childInputs = parentElementModal.children;
        let reasons = getCookie('reasonsList');
        if (reasons === '') {
          console.log(`cookie empty, returning`);
          return;
        }
        let reasonsArray = reasons.split(",");
        console.log(`cookie contents= ${reasons}`);

        let reasonsForm = document.getElementById("reasonsForm");

        for (var i = 0; i < reasonsForm.length; i++) {
          console.log(`checkbox ${i} = ${reasonsForm[i].value}`);
          numberOfReasons++;
        }

        updateBtnHTML();
        
        for (i = 0; i < reasonsArray.length; i++) {
          let defaultReason = false;
          console.log(`analysing option ${reasonsArray[i]}`);
          for (j = 0; j < reasonsForm.length; j++) {
            if (reasonsForm[j].value == reasonsArray[i]) {
              console.log(`input value ${reasonsForm[j].value} == ${reasonsArray[i]}, checked`);
              reasonsForm[j].checked = true;
              defaultReason = true;
            }
          }
          if (!defaultReason) {
            console.log(`adding custom option ${reasonsArray[i]}`);
            replaceCustomOption(reasonsArray[i]);
          }
          addReasonDiv(reasonsArray[i]);
        }
      }

      function selectBtnOption(btnID) {
        let button = document.getElementById(btnID);
        button.classList.toggle("selected");
  
        if (btnID == "reason9") {
          x = document.getElementById("own-reason-area");

          if (x.style.display === "block") {
            x.style.display = "none";
          } else {
            x.style.display = "block";
          }
        }
      }

      function replaceCustomOption(text) {
        let ownReasonTextArea = document.getElementById("ownReason");

        let parentElement = document.getElementById("reasonsList");
        let divWrapper = document.createElement('div');
        let input = document.createElement('input');
        let label = document.createElement('label');
        
        divWrapper.classList.add("form-check");
        divWrapper.classList.add("reasons-checkbox");
        divWrapper.classList.add("custom-reason-checkbox");

        input.classList.add("form-check-input");
        input.classList.add("reasons-input");
        input.name = "reasonsOption";
        input.type = "checkbox";
        input.value = text;
        input.id = "reasonCustomX";
        input.checked = true;

        label.classList.add("form-check-label");       
        label.htmlFor = "reasonCustomX";       
        label.innerHTML = text;       

        parentElement.appendChild(divWrapper);
        divWrapper.appendChild(input);
        divWrapper.appendChild(label);

        ownReasonTextArea.value = "";
      }

      function addCustomOption(text) {
        let ownReasonTextArea = document.getElementById("ownReason");

        if (ownReasonTextArea.value === "") {
          console.log("reasons empty, returning");
          ownReasonTextArea.classList.add("error");
          return;
        }
        ownReasonTextArea.classList.remove("error");

        let parentElement = document.getElementById("reasonsList");
        let divWrapper = document.createElement('div');
        let input = document.createElement('input');
        let label = document.createElement('label');
        
        divWrapper.classList.add("form-check");
        divWrapper.classList.add("reasons-checkbox");
        divWrapper.classList.add("custom-reason-checkbox");

        input.classList.add("form-check-input");
        input.classList.add("reasons-input");
        input.name = "reasonsOption";
        input.type = "checkbox";
        input.value = text;
        input.id = "reasonCustomX";
        input.checked = true;

        label.classList.add("form-check-label");       
        label.htmlFor = "reasonCustomX";       
        label.innerHTML = text;       

        parentElement.appendChild(divWrapper);
        divWrapper.appendChild(input);
        divWrapper.appendChild(label);

        ownReasonTextArea.value = "";
      }

      function addReasonDiv(text) {
        let parentElement = document.getElementById("reasons-area-row");
        let column = document.createElement('div');
        let newElement = document.createElement('div');

        column.classList.add("col-12");
        column.classList.add("col-md-5");
        newElement.classList.add("interactive-text-box");
        newElement.innerHTML = text;
        
        parentElement.appendChild(column);
        column.appendChild(newElement);
        numberOfReasons++;
      }

      function clearItems() {
        let parentElement = document.getElementById("reasons-area-row");
        let children = parentElement.childNodes;

        while (children.length > 2) {
          let child = parentElement.lastElementChild;
          console.log(`child id= ${child.id}`);
          if (child.id != "addReasonsDiv") {
            parentElement.removeChild(child);
          }
          else break;
        }
      }

      function submitFormConfirm(checkboxObject) {

        clearItems();
        numberOfReasons = 0;

        let addEditReasonsBtn = document.getElementById("addEditReasonsBtn");
        let selectedChoices = null;


        for (var i = 0; i < checkboxObject.length; i++) {
          console.log(`checkbox ${i} = ${checkboxObject[i].checked}`);
          if (checkboxObject[i].checked) {
            let reasonText = checkboxObject[i].nextElementSibling.innerHTML;
            console.log(`sibling text=${reasonText}`);
            addReasonDiv(reasonText);
            numberOfReasons++;
          }
        }

        console.log(`numberOfReasons= ${numberOfReasons}`);

        updateBtnHTML();
      }

      function updateBtnHTML() {
        if (numberOfReasons > 0) {
          addEditReasonsBtn.innerHTML = 
          `<svg width="28" height="28" viewBox="0 0 32 30" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M13 23C7.4875 23 3 18.5125 3 13C3 7.4875 7.4875 3 13 3C18.5125 3 23 7.4875 23 13C23 18.5125 18.5125 23 13 23ZM13 0.5C11.3585 0.5 9.73303 0.823322 8.21646 1.45151C6.69989 2.07969 5.3219 3.00043 4.16117 4.16117C1.81696 6.50537 0.5 9.68479 0.5 13C0.5 16.3152 1.81696 19.4946 4.16117 21.8388C5.3219 22.9996 6.69989 23.9203 8.21646 24.5485C9.73303 25.1767 11.3585 25.5 13 25.5C16.3152 25.5 19.4946 24.183 21.8388 21.8388C24.183 19.4946 25.5 16.3152 25.5 13C25.5 11.3585 25.1767 9.73303 24.5485 8.21646C23.9203 6.69989 22.9996 5.3219 21.8388 4.16117C20.6781 3.00043 19.3001 2.07969 17.7835 1.45151C16.267 0.823322 14.6415 0.5 13 0.5ZM14.25 6.75H11.75V11.75H6.75V14.25H11.75V19.25H14.25V14.25H19.25V11.75H14.25V6.75Z" fill="white"/>
          </svg>Add or edit reason/s`;
        } else {
          addEditReasonsBtn.innerHTML = 
          `<svg width="28" height="28" viewBox="0 0 32 30" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M13 23C7.4875 23 3 18.5125 3 13C3 7.4875 7.4875 3 13 3C18.5125 3 23 7.4875 23 13C23 18.5125 18.5125 23 13 23ZM13 0.5C11.3585 0.5 9.73303 0.823322 8.21646 1.45151C6.69989 2.07969 5.3219 3.00043 4.16117 4.16117C1.81696 6.50537 0.5 9.68479 0.5 13C0.5 16.3152 1.81696 19.4946 4.16117 21.8388C5.3219 22.9996 6.69989 23.9203 8.21646 24.5485C9.73303 25.1767 11.3585 25.5 13 25.5C16.3152 25.5 19.4946 24.183 21.8388 21.8388C24.183 19.4946 25.5 16.3152 25.5 13C25.5 11.3585 25.1767 9.73303 24.5485 8.21646C23.9203 6.69989 22.9996 5.3219 21.8388 4.16117C20.6781 3.00043 19.3001 2.07969 17.7835 1.45151C16.267 0.823322 14.6415 0.5 13 0.5ZM14.25 6.75H11.75V11.75H6.75V14.25H11.75V19.25H14.25V14.25H19.25V11.75H14.25V6.75Z" fill="white"/>
          </svg>Add reason/s`;
        }
      }

      function submitFormContinue(reasons) {
        let reasonsList = [];

        for (var i = 0; i < reasons.length; i++) {
          if (reasons[i].checked) {
            text = reasons[i].value;
            reasonsList.push(text);
            console.log(`added reason ${text}`);
          }
        }

        console.log(`list of reasons= ${reasonsList}`);

        let hour = 1/24;
        setCookie('reasonsList', reasonsList, hour);

        window.location.href = "{{ '/alcohol-goals-and-plan/goal-setting' | url }}";
      }

      function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        let expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      }

      function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for(let i = 0; i <ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }

      function submitFormBack() {
        window.location.href = "{{ '/alcohol-goals-and-plan/' | url }}";
      }

    </script>

  </section>
{% endblock %}
